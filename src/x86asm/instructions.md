# Референс по инструкциям

# Типы операндов

Ассемблерные инструкции принимают _операнды_, которые могут быть нескольких
типов.
- Числовые константы. В документации они обычно обозначаются как `immXX`
  (immediate), где `XX` --- длина константы в битах.
- Регистры. Обозначаются как `rXX` (register), где `XX` --- битность регистра.
  Например, `r64` --- в некотором смысле аналог `uint64_t`.
- Адреса в памяти. Обозначение: `mXX` (memory), где `XX` кодирует `sizeof`
  типа, на который ссылается адрес. К примеру, `m64` --- нечто похожее на
  `uint64_t*`.

> Бывают еще другие типы, например, абсолютные (`moffsXX`) или относительные
> (`relXX`) смещения. Они тоже некоторым образом задают адреса в памяти, но нам
> пока что не понадобятся.

## Регистры

Регистры --- это ячейки памяти, в которых процессор производит вычисления. Они
бывают разными.
[Картинку](https://en.wikipedia.org/wiki/X86#/media/File:Table_of_x86_Registers_svg.svg)
проще рассмотреть в отдельной вкладке.

![x86_regs](x86_regs.svg)

Основные виды регистров такие.
1. General purpose регистры `rax`, `rbx`, `rcx`, `rdx`, `rdi`, `rsi` и
   `r8`--`r15`. Они используются как слоты для числовых переменных и
   указателей. Такие регистры 64-битные. На более старых процессорах были
   только 32-, 16- и 8-битные регистры. Например, `eax` --- младшие 32 бита
   `rax`, `ax` --- младшие 16 бит `eax`, а `al` (lower) и `ah` (higher) ---
   8-битные половинки `ax`.
1. Системные регистры: `rflags` --- флаги, которые проставляются при сравнениях
   чисел и в результате арифметических операций, `rip` --- указатель на текущую
   инструкцию, `rsp` --- указатель на верхушку стека, `rbp` --- указатель на
   границу стекового фрейма. Их подробнее обсудим позже.
1. Широкие регистры `xmm0`--`xmm15`, `ymm0`--`ymm15` и `zmm0`--`zmm15`. Они
   тоже росли постепенно, поэтому вложены друг в друга. Такие регистры
   используются для "векторных" операций: например, в них можно
   записать несколько `int32_t` и потом попарно сложить как короткие векторы.
   Еще эти регистры по совместительству используются для вещественной
   арифметики, в них можно хранить `float` и `double`.
1. Стековые регистры сопроцессора [x87](https://en.wikipedia.org/wiki/X87)
   `st(0)`--`st(7)`. В более старых процессорах вещественная арифметика была
   реализована в отдельном
   [FPU](https://en.wikipedia.org/wiki/Floating-point_unit) --- сопроцессоре
   x87. Чтобы передать в него данные и получить обратно, использовались эти
   регистры.
1. Регистры с настройками --- `cr0`--`cr15`, `cs`, `ss`, `ds`, `es`, `fs` и
   многие другие. Например, `cr0` и `cr3`
   [влияют](https://wiki.osdev.org/Paging) на то, как процессор будет ходить в
   память, отображая виртуальные адреса (собственное адресное пространство для
   каждого процесса) в физические (общее адресное пространство внутри всей
   оперативной памяти).

## Адреса в памяти

Адреса задаются в ассемблере конструкцией вида `[base + index * scale +
offset]`. Чтобы ее понять, можно представить, что есть массив структур
аллоцированный по адресу `base`. Размер одной структуры --- это `scale`,
`index` --- индекс элемента массива, а `offset` --- смещение, чтобы выбрать
какое-то поле внутри структуры. Поэтому есть ограничения: `scale` и `offset`
должны быть константами (`sizeof` структуры и смещения полей известны в compile
time), а `base` и `index` могут быть константами либо регистрами.
